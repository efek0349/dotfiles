#!/bin/bash
username=`logname`
tmp_template=$(mktemp -d -t vpnbook.XXXXXX)
tmp_ovpns="vpnbook-ovpn.list"
tmp_doas="vpnbook-doas.conf"

curl -sSL  https://www.vpnbook.com/freevpn |
			grep '/free-openvpn-account/'   |
			awk -F\" '{ printf "https://www.vpnbook.com%s\n", $2 }' >${tmp_template}/${tmp_ovpns}

cd -- ${tmp_template}

for i in $(cat ${tmp_ovpns});
 do
	wget $i;
 done

for i in $(cat ${tmp_ovpns} | awk -F/ '{print $5}');
do
 bsdtar -xf ${tmp_template}/$i
done

cd -- ${tmp_template}

#rm *.zip
find  ${tmp_template} -type f -name  '*.ovpn' -exec cp -v {} /var/account/local/vpnbook/ \;
sed -i 's/auth-user-pass/auth-user-pass \/home\/efek\/code\/vpnbook-password.txt/g' /var/account/local/vpnbook/*.ovpn
cat << EOF >vpnbook-random-connect.sh
#!/bin/bash
servers=\$(echo '`printf "%s\n" "$(ls -h /var/account/local/vpnbook/)"`' | sort -R | head -1)
doas /usr/sbin/openvpn --config /var/account/local/vpnbook/"\$servers"
EOF

for i in $(printf "%s\n" "`ls /var/account/local/vpnbook/*.ovpn`");
 do
  printf "permit nopass `logname` as root cmd /usr/sbin/openvpn args --config ${i}\n"
 done > ${tmp_doas}
